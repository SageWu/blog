# TCP

## 报文格式

```txt
0                     15 16                    31
+-----------------------+-----------------------+
|                       |                       |
|     source port       |   destination port    |
|                       |                       |
+-----------------------+-----------------------+
|                                               |
|               sequence number                 |
|                                               |
+-----------------------------------------------+
|                                               |
|          acknowledgement number               |
|                                               |
+------+----+-+-+-+-+-+-+-----------------------+
|header|    |u|a|p|r|s|f|                       |
|length|    |r|c|s|s|y|i|    window size        |
|      |    |g|k|h|t|n|n|                       |
+------+----+-+-+-+-+-+-+-----------------------+
|                       |                       |
|       checksum        |    urgent pointer     |
|                       |                       |
+-----------------------+-----------------------+
|                                               |
|                 options                       |
|                                               |
+-----------------------------------------------+
|                                               |
|                   data                        |
|                                               |
+-----------------------------------------------+
```

## 三次握手

1. 客户端发送`syn`报文，并带上初始化序列号x。
2. 服务端发送`syn + ack`报文，并带上初始化序列号y，以及请求序列号x + 1。
3. 客户端发送`ack`报文，序列号为x + 1,请求序列号为y + 1。

三次握手原因？\
确认双方的发送能力和接收能力。如果为两次握手，则没办法确认客户端的接收能力。

第三次握手是否可以携带数据？\
可以，因为这个时候客户端确认了服务端的发送能力和接收能力。如果之前的握手允许携带数据，则服务器在建立连接前就需处理数据，增加了被攻击的风险。

## 四次挥手

1. 客户端发送`fin`报文。
2. 服务端发送`ack`报文。
3. 服务端发送`fin`报文。
4. 客户端发送`ack`报文。

> 该流程也可以由服务先发起`fin`报文

四次挥手原因？\
因为连接是全双工的，各自方向都需要进行关闭。如果合并`fin`和`ack`，由于服务端还有数据需要发送，导致客户端长时间未收到`ack`进行重试。

等待`2MSL`的原因？\
确保`ack`报文丢失后，服务端可以重发`fin`报文；确保该连接的报文都消失在网络中。

## 滑动窗口

发送端和接收端各自维持一个缓存区。提高吞吐量，解决报文无序、重复、丢失的问题。\
窗口大小取流量控制和拥塞控制决定的窗口大小的最小值。

## 流量控制

接收方处理数据速度较，造成缓存区中数据的增长，告知发送方减少数据的发送。

## 拥塞控制

* 慢启动。每接收到一个ack报文，窗口大小加一。增长速度为指数。
* 拥塞避免。当达到阀值后，每接收到窗口大小个的ack报文后，窗口大小加一。增长速度为线性。
* 快速重传。当发生报文丢失，接收方发送3个ack报文，发送方进行重传。
* 快速恢复。当发生快速重传，阀值变成窗口大小的一半，窗口大小变成阀值大小。
